#!/bin/bash

set -eu

BACKUP_FILE=/backup/mediawiki-backup.tar

TMP_FOLDER=`mktemp -d`
cd $TMP_FOLDER

tar xf $BACKUP_FILE

# show version
echo got version `cat mediawiki-backup.version`

# restoring db
echo restoring mysql db
bzip2 -d mysqldump.sql.bz2
MYSQL_PWD=$MYSQL_ROOT_PASSWORD mysql --default-character-set=utf8 wiki < mysqldump.sql

# restoring images
rm -rf /var/www/html/images/* /var/www/html/images/.??*
tar -xf $BACKUP_FILE -C /var/www/html

echo restored $BACKUP_FILE
